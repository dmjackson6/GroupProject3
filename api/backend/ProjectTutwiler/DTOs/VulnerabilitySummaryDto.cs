using ProjectTutwiler.Models;
using ProjectTutwiler.Models.Enums;

namespace ProjectTutwiler.DTOs;

/// <summary>
/// Lightweight DTO for vulnerability list views
/// </summary>
public class VulnerabilitySummaryDto
{
    public int Id { get; set; }
    public string CveId { get; set; } = string.Empty;
    public string DescriptionPreview { get; set; } = string.Empty;
    public decimal? CvssScore { get; set; }
    public bool KnownExploited { get; set; }
    public string? VendorName { get; set; }
    public DateTime? PublishedDate { get; set; }
    public string PublishedDateFormatted => PublishedDate?.ToString("yyyy-MM-dd") ?? "N/A";
    
    // Bio Impact
    public bool IsAnalyzed { get; set; }
    public PriorityLevel? PriorityLevel { get; set; }
    public string PriorityLevelString => PriorityLevel?.ToString() ?? "Unanalyzed";
    public decimal? CompositeScore { get; set; }
    
    // UI Helpers
    public string PriorityBadgeColor
    {
        get
        {
            if (!PriorityLevel.HasValue) return "gray";
            return PriorityLevel switch
            {
                Models.Enums.PriorityLevel.CRITICAL => "red",
                Models.Enums.PriorityLevel.HIGH => "orange",
                Models.Enums.PriorityLevel.MEDIUM => "yellow",
                Models.Enums.PriorityLevel.LOW => "green",
                _ => "gray"
            };
        }
    }

    public static VulnerabilitySummaryDto FromEntity(Vulnerability vulnerability)
    {
        var description = vulnerability.Description;
        var preview = description.Length > 150 
            ? description.Substring(0, 150) + "..." 
            : description;

        return new VulnerabilitySummaryDto
        {
            Id = vulnerability.Id,
            CveId = vulnerability.CveId,
            DescriptionPreview = preview,
            CvssScore = vulnerability.CvssScore,
            KnownExploited = vulnerability.KnownExploited,
            VendorName = vulnerability.VendorName,
            PublishedDate = vulnerability.PublishedDate,
            IsAnalyzed = vulnerability.BioImpactScore != null,
            PriorityLevel = vulnerability.BioImpactScore?.PriorityLevel,
            CompositeScore = vulnerability.BioImpactScore?.CompositeScore
        };
    }
}

