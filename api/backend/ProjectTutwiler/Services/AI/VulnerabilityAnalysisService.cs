using Newtonsoft.Json;
using ProjectTutwiler.Data;
using ProjectTutwiler.Models;
using ProjectTutwiler.Models.Enums;
using ProjectTutwiler.Services.AI.DTOs;
using ProjectTutwiler.Services.Scoring;

namespace ProjectTutwiler.Services.AI;

public class VulnerabilityAnalysisService
{
    private readonly BioImpactAnalyzer _bioAnalyzer;
    private readonly CompositeScorer _compositeScorer;
    private readonly IVulnerabilityRepository _repository;
    private readonly ApplicationDbContext _context;
    private readonly ILogger<VulnerabilityAnalysisService> _logger;

    public VulnerabilityAnalysisService(
        BioImpactAnalyzer bioAnalyzer,
        CompositeScorer compositeScorer,
        IVulnerabilityRepository repository,
        ApplicationDbContext context,
        ILogger<VulnerabilityAnalysisService> logger)
    {
        _bioAnalyzer = bioAnalyzer;
        _compositeScorer = compositeScorer;
        _repository = repository;
        _context = context;
        _logger = logger;
    }

    public async Task<BioImpactScore?> AnalyzeAndScoreVulnerabilityAsync(int vulnerabilityId)
    {
        try
        {
            _logger.LogInformation("Starting analysis and scoring for vulnerability ID {Id}", vulnerabilityId);

            // Fetch vulnerability from database
            var vulnerability = await _context.Vulnerabilities.FindAsync(vulnerabilityId);
            
            if (vulnerability == null)
            {
                _logger.LogWarning("Vulnerability {Id} not found", vulnerabilityId);
                throw new InvalidOperationException($"Vulnerability {vulnerabilityId} not found");
            }

            // Check if already analyzed
            var existingScore = _context.BioImpactScores.FirstOrDefault(b => b.VulnerabilityId == vulnerabilityId);
            if (existingScore != null)
            {
                _logger.LogInformation("Vulnerability {CveId} already has analysis, skipping", vulnerability.CveId);
                return existingScore;
            }

            // Run AI analysis
            var analysis = await _bioAnalyzer.AnalyzeVulnerabilityAsync(vulnerability);

            // Use CompositeScorer to calculate all dimension scores and priority
            var bioImpactScore = _compositeScorer.CalculateCompositeScore(vulnerability, analysis);

            // Save to database
            _context.BioImpactScores.Add(bioImpactScore);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Created score for {CveId}: Composite={CompositeScore}, Priority={Priority}",
                vulnerability.CveId, bioImpactScore.CompositeScore, bioImpactScore.PriorityLevel);

            return bioImpactScore;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error analyzing and scoring vulnerability {Id}", vulnerabilityId);
            throw;
        }
    }
}

