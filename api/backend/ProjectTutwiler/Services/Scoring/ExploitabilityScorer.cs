using ProjectTutwiler.Models;
using ProjectTutwiler.Services.AI.DTOs;

namespace ProjectTutwiler.Services.Scoring;

public class ExploitabilityScorer
{
    private readonly ILogger<ExploitabilityScorer> _logger;

    public ExploitabilityScorer(ILogger<ExploitabilityScorer> logger)
    {
        _logger = logger;
    }

    public int Calculate(Vulnerability vulnerability, BioRelevanceAnalysis aiAnalysis)
    {
        // If actively exploited (CISA KEV), highest score
        if (vulnerability.KnownExploited)
        {
            _logger.LogInformation("Known exploited: maximum score 100 for {CveId}", vulnerability.CveId);
            return 100;
        }

        int score;

        // Base score from CVSS
        if (vulnerability.CvssScore.HasValue)
        {
            var cvss = vulnerability.CvssScore.Value;

            if (cvss >= 9.0m)
            {
                score = 80;
                _logger.LogDebug("CVSS >= 9.0: base score 80");
            }
            else if (cvss >= 7.0m)
            {
                score = 60;
                _logger.LogDebug("CVSS >= 7.0: base score 60");
            }
            else if (cvss >= 4.0m)
            {
                score = 40;
                _logger.LogDebug("CVSS >= 4.0: base score 40");
            }
            else
            {
                score = 20;
                _logger.LogDebug("CVSS < 4.0: base score 20");
            }
        }
        else
        {
            score = 20; // No CVSS available
            _logger.LogDebug("No CVSS score available: default base score 20");
        }

        // Boost for network attack vector (remotely exploitable)
        if (!string.IsNullOrWhiteSpace(vulnerability.CvssVector) &&
            vulnerability.CvssVector.Contains("AV:N", StringComparison.OrdinalIgnoreCase))
        {
            score = Math.Min(score + 20, 100);
            _logger.LogDebug("Network attack vector (AV:N) detected: +20 boost (capped at 100)");
        }

        _logger.LogInformation("Exploitability Score calculated: {Score} for {CveId}", score, vulnerability.CveId);
        return score;
    }
}

