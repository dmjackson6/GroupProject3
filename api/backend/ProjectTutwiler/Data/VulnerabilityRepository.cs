using Microsoft.EntityFrameworkCore;
using ProjectTutwiler.Models;
using ProjectTutwiler.Models.Enums;

namespace ProjectTutwiler.Data;

public class VulnerabilityRepository : IVulnerabilityRepository
{
    private readonly ApplicationDbContext _context;
    private readonly ILogger<VulnerabilityRepository> _logger;

    public VulnerabilityRepository(ApplicationDbContext context, ILogger<VulnerabilityRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    public async Task<Vulnerability?> GetByCveIdAsync(string cveId)
    {
        try
        {
            return await _context.Vulnerabilities
                .Include(v => v.BioImpactScore)
                .Include(v => v.ActionRecommendations)
                .FirstOrDefaultAsync(v => v.CveId == cveId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving vulnerability by CVE ID: {CveId}", cveId);
            throw;
        }
    }

    public async Task<Vulnerability?> GetByIdWithScoreAsync(int id)
    {
        try
        {
            return await _context.Vulnerabilities
                .Include(v => v.BioImpactScore)
                .Include(v => v.ActionRecommendations)
                .FirstOrDefaultAsync(v => v.Id == id);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving vulnerability by ID: {Id}", id);
            throw;
        }
    }

    public async Task<List<Vulnerability>> GetAllAsync(int skip = 0, int take = 100)
    {
        try
        {
            return await _context.Vulnerabilities
                .Include(v => v.BioImpactScore)
                .Include(v => v.ActionRecommendations)
                .OrderByDescending(v => v.CreatedAt)
                .Skip(skip)
                .Take(take)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving vulnerabilities");
            throw;
        }
    }

    public async Task<Vulnerability> AddAsync(Vulnerability vulnerability)
    {
        try
        {
            vulnerability.CreatedAt = DateTime.UtcNow;
            vulnerability.UpdatedAt = DateTime.UtcNow;

            await _context.Vulnerabilities.AddAsync(vulnerability);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Successfully added vulnerability: {CveId}", vulnerability.CveId);
            return vulnerability;
        }
        catch (DbUpdateException ex)
        {
            _logger.LogError(ex, "Database error adding vulnerability: {CveId}", vulnerability.CveId);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error adding vulnerability: {CveId}", vulnerability.CveId);
            throw;
        }
    }

    public async Task<bool> ExistsAsync(string cveId)
    {
        try
        {
            return await _context.Vulnerabilities.AnyAsync(v => v.CveId == cveId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error checking if vulnerability exists: {CveId}", cveId);
            throw;
        }
    }

    public async Task UpdateAsync(Vulnerability vulnerability)
    {
        try
        {
            vulnerability.UpdatedAt = DateTime.UtcNow;
            _context.Vulnerabilities.Update(vulnerability);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Successfully updated vulnerability: {CveId}", vulnerability.CveId);
        }
        catch (DbUpdateException ex)
        {
            _logger.LogError(ex, "Database error updating vulnerability: {CveId}", vulnerability.CveId);
            throw;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error updating vulnerability: {CveId}", vulnerability.CveId);
            throw;
        }
    }

    public async Task<List<Vulnerability>> GetByPriorityLevelAsync(PriorityLevel level)
    {
        try
        {
            return await _context.Vulnerabilities
                .Include(v => v.BioImpactScore)
                .Include(v => v.ActionRecommendations)
                .Where(v => v.BioImpactScore != null && v.BioImpactScore.PriorityLevel == level)
                .OrderByDescending(v => v.CreatedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving vulnerabilities by priority level: {Level}", level);
            throw;
        }
    }

    public async Task<int> CountKnownExploitedAsync()
    {
        try
        {
            return await _context.Vulnerabilities
                .Where(v => v.KnownExploited)
                .CountAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error counting known exploited vulnerabilities");
            throw;
        }
    }
}
