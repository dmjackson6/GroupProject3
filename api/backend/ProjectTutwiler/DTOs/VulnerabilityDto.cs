using ProjectTutwiler.Models;
using ProjectTutwiler.Models.Enums;

namespace ProjectTutwiler.DTOs;

public class VulnerabilityDto
{
    public int Id { get; set; }
    public string CveId { get; set; } = string.Empty;
    public DateTime? PublishedDate { get; set; }
    public string PublishedDateFormatted => PublishedDate?.ToString("yyyy-MM-dd HH:mm UTC") ?? "N/A";
    public string Description { get; set; } = string.Empty;
    public decimal? CvssScore { get; set; }
    public string CvssVector { get; set; } = string.Empty;
    public string VendorName { get; set; } = string.Empty;
    public bool KnownExploited { get; set; }
    public string SourceName { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
    public string CreatedAtFormatted => CreatedAt.ToString("yyyy-MM-dd HH:mm UTC");

    // Bio Impact Score (if analyzed)
    public BioImpactScoreDto? BioImpactScore { get; set; }

    // Action Recommendations count
    public int RecommendationCount { get; set; }

    // UI Helper Properties
    public string PriorityBadgeColor
    {
        get
        {
            if (BioImpactScore == null) return "gray";
            return BioImpactScore.PriorityLevel switch
            {
                PriorityLevel.CRITICAL => "red",
                PriorityLevel.HIGH => "orange",
                PriorityLevel.MEDIUM => "yellow",
                PriorityLevel.LOW => "green",
                _ => "gray"
            };
        }
    }

    public string SeverityLabel
    {
        get
        {
            if (CvssScore == null) return "Unknown";
            if (CvssScore >= 9.0m) return "Critical";
            if (CvssScore >= 7.0m) return "High";
            if (CvssScore >= 4.0m) return "Medium";
            return "Low";
        }
    }

    public static VulnerabilityDto FromEntity(Vulnerability vulnerability)
    {
        return new VulnerabilityDto
        {
            Id = vulnerability.Id,
            CveId = vulnerability.CveId,
            PublishedDate = vulnerability.PublishedDate,
            Description = vulnerability.Description,
            CvssScore = vulnerability.CvssScore,
            CvssVector = vulnerability.CvssVector ?? string.Empty,
            VendorName = vulnerability.VendorName ?? string.Empty,
            KnownExploited = vulnerability.KnownExploited,
            SourceName = vulnerability.SourceName,
            CreatedAt = vulnerability.CreatedAt,
            BioImpactScore = vulnerability.BioImpactScore != null 
                ? BioImpactScoreDto.FromEntity(vulnerability.BioImpactScore) 
                : null,
            RecommendationCount = vulnerability.ActionRecommendations?.Count ?? 0
        };
    }
}

public class BioImpactScoreDto
{
    public int Id { get; set; }
    public int HumanSafetyScore { get; set; }
    public int SupplyChainScore { get; set; }
    public int ExploitabilityScore { get; set; }
    public int PatchAvailabilityScore { get; set; }
    public decimal CompositeScore { get; set; }
    public PriorityLevel PriorityLevel { get; set; }
    public string PriorityLevelString => PriorityLevel.ToString();
    public decimal? BioRelevanceConfidence { get; set; }
    public string? AffectedBioSectors { get; set; }
    public DateTime CreatedAt { get; set; }

    public static BioImpactScoreDto FromEntity(BioImpactScore score)
    {
        return new BioImpactScoreDto
        {
            Id = score.Id,
            HumanSafetyScore = score.HumanSafetyScore,
            SupplyChainScore = score.SupplyChainScore,
            ExploitabilityScore = score.ExploitabilityScore,
            PatchAvailabilityScore = score.PatchAvailabilityScore,
            CompositeScore = score.CompositeScore,
            PriorityLevel = score.PriorityLevel,
            BioRelevanceConfidence = score.BioRelevanceConfidence,
            AffectedBioSectors = score.AffectedBioSectors,
            CreatedAt = score.CreatedAt
        };
    }
}

